<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SMART 个人目标管理（简化版·AI评估驱动）</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#101a2f;
      --text:#e8eefc;
      --muted:#a9b6d6;
      --line:#243252;
      --ok:#22c55e;
      --warn:#fbbf24;
      --bad:#fb7185;
      --btn:#3b82f6;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --r: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "PingFang SC","Hiragino Sans GB","Microsoft YaHei", "Noto Sans CJK SC", sans-serif;
      background:
        radial-gradient(1100px 700px at 15% 0%, rgba(59,130,246,.22), transparent 55%),
        radial-gradient(900px 600px at 90% 20%, rgba(34,197,94,.16), transparent 55%),
        linear-gradient(180deg, #070c16 0%, #0b1220 100%);
      color:var(--text);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:18px 14px 50px;}
    header{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      margin-bottom:12px;
    }
    header h1{margin:0; font-size:18px; letter-spacing:.2px;}
    header p{margin:6px 0 0 0; color:var(--muted); font-size:12.5px; line-height:1.6;}
    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:10px 12px;
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
      box-shadow: var(--shadow);
      white-space:nowrap;
    }
    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:10px;
      border:1px solid var(--line);
      border-radius: var(--r);
      background: rgba(255,255,255,.02);
      box-shadow: var(--shadow);
      margin: 12px 0 14px 0;
    }
    .tab{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition:.15s ease;
      font-size:13px;
      display:flex; gap:8px; align-items:center;
    }
    .tab:hover{transform:translateY(-1px); border-color: rgba(59,130,246,.6); color: var(--text);}
    .tab.active{
      background: linear-gradient(180deg, rgba(59,130,246,.22), rgba(59,130,246,.06));
      border-color: rgba(59,130,246,.75);
      color: var(--text);
    }
    .badge{
      width:22px; height:22px;
      border-radius:999px;
      display:inline-flex; align-items:center; justify-content:center;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size:12px;
    }
    .tab.active .badge{
      border-color: rgba(59,130,246,.75);
      color: var(--text);
      background: rgba(59,130,246,.22);
    }

    .card{
      border:1px solid var(--line);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{margin:0 0 10px 0; font-size:16px;}
    .card h3{margin:0 0 8px 0; font-size:14px;}
    .muted{color:var(--muted);}
    .hint{color:var(--muted); font-size:12px; line-height:1.6; margin-top:6px;}
    .msg{white-space: pre-wrap;} /* 关键：让错误信息换行可读 */
    .grid{display:grid; gap:12px;}
    @media(min-width:980px){
      .grid.cols2{grid-template-columns: 1fr 1fr;}
      .grid.cols3{grid-template-columns: 1fr 1fr 1fr;}
    }

    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px;}
    label{font-size:12px; color:var(--muted);}
    input[type="text"], input[type="number"], input[type="date"], textarea, select{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.14);
      color: var(--text);
      outline:none;
      transition:.15s ease;
    }
    textarea{min-height:86px; resize:vertical;}
    input:focus, textarea:focus, select:focus{
      border-color: rgba(59,130,246,.75);
      box-shadow: 0 0 0 3px rgba(59,130,246,.14);
    }
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    button{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px 12px;
      background: rgba(255,255,255,.03);
      color: var(--text);
      cursor:pointer;
      transition:.15s ease;
      font-size:13px;
    }
    button:hover{transform:translateY(-1px); border-color: rgba(59,130,246,.6);}
    button:disabled{opacity:.6; cursor:not-allowed; transform:none;}
    .primary{background: linear-gradient(180deg, rgba(59,130,246,.95), rgba(59,130,246,.65)); border-color: rgba(59,130,246,.9);}
    .success{background: linear-gradient(180deg, rgba(34,197,94,.95), rgba(34,197,94,.65)); border-color: rgba(34,197,94,.9);}
    .danger{background: rgba(251,113,133,.12); border-color: rgba(251,113,133,.35);}
    .mini{padding:8px 10px; border-radius:10px; font-size:12px;}

    .hidden{display:none!important;}
    .divider{height:1px; background: var(--line); margin:12px 0;}
    .list{display:flex; flex-direction:column; gap:10px;}
    .item{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding:12px;
    }
    .itemhead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .itemhead strong{font-size:14px; line-height:1.35;}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .tag.ok{border-color: rgba(34,197,94,.55); color: rgba(34,197,94,1); background: rgba(34,197,94,.08);}
    .tag.warn{border-color: rgba(251,191,36,.55); color: rgba(251,191,36,1); background: rgba(251,191,36,.08);}
    .tag.bad{border-color: rgba(251,113,133,.55); color: rgba(251,113,133,1); background: rgba(251,113,133,.08);}
    .mono{font-family: var(--mono);}

    .checkboxes{
      display:flex; flex-wrap:wrap; gap:8px;
      padding:10px;
      border:1px solid var(--line);
      border-radius: 12px;
      background: rgba(0,0,0,.12);
    }
    .checkboxes label{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      padding:6px 10px;
      border-radius:999px;
      cursor:pointer;
      font-size:12px;
      color: var(--muted);
    }
    .checkboxes input{accent-color: var(--btn);}

    .note{
      border:1px dashed rgba(169,182,214,.35);
      background: rgba(255,255,255,.02);
      padding:10px 12px;
      border-radius: 12px;
      color: var(--muted);
      font-size:12px;
      line-height:1.65;
    }

    .kpi{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-top:10px;
    }
    .kpi .box{
      flex:1 1 220px;
      border:1px solid var(--line);
      border-radius: 12px;
      background: rgba(255,255,255,.02);
      padding:12px;
    }
    .kpi .v{font-family: var(--mono); font-size:16px;}
    .kpi .t{font-size:12px; color: var(--muted); margin-top:4px;}

    .twoCol{
      display:grid; gap:10px;
    }
    @media(min-width:980px){ .twoCol{grid-template-columns: 1fr 1fr;} }

    .kv{
      display:grid; gap:6px;
      font-size:12px;
      line-height:1.6;
      color: var(--muted);
    }
    .kv b{color: var(--text); font-weight:600;}
    .hrMini{height:1px; background: rgba(36,50,82,.8); margin:10px 0;}

    /* 打印/导出PDF：只保留打印区 */
    @media print{
      body{background:#fff !important; color:#000 !important;}
      .no-print{display:none !important;}
      .wrap{max-width: 100% !important; padding:0 !important;}
      #printArea{
        display:block !important;
        padding: 18mm 16mm;
      }
      #printArea .print-card{
        border: 1px solid #ddd !important;
        border-radius: 10px !important;
        box-shadow: none !important;
        background: #fff !important;
        color:#000 !important;
        padding: 12px !important;
        margin-bottom: 10px !important;
      }
      #printArea h2, #printArea h3{color:#000 !important;}
      #printArea .muted{color:#444 !important;}
      #printArea .tag{border-color:#bbb !important; color:#111 !important; background:#f6f6f6 !important;}
      #printArea .tag.ok{background:#eafff2 !important;}
      #printArea .tag.warn{background:#fff6df !important;}
      #printArea .tag.bad{background:#ffe7ec !important;}
      a{color:#000 !important; text-decoration:none !important;}
      .pagebreak{page-break-before: always;}
      ul{margin-top:6px !important;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header class="no-print">
      <div>
        <h1>SMART 个人目标管理（简化版·AI评估驱动）</h1>
        <p>
          流程：写清 <span class="mono">S / M / T</span> → 盘点资源与举措（<span class="mono">A</span>）→ 分析相关方需求与互换（<span class="mono">R</span>）→ 输出并导出 PDF。<br/>
          <span class="muted">说明：</span>“成功概率”= <b>成功准备度概率</b>（readiness），用于理性取舍与复盘。
        </p>
      </div>
      <div class="pill" title="点击评估/再评估会调用 /api/ai（后端建议部署到Vercel，使用DEEPSEEK_API_KEY）。">DeepSeek AI · 概率评估 · 策略建议 · PDF导出</div>
    </header>

    <div class="tabs no-print" role="tablist" aria-label="steps">
      <button class="tab active" data-step="1" role="tab"><span class="badge">1</span> S/M/T</button>
      <button class="tab" data-step="2" role="tab"><span class="badge">2</span> A：资源 + 举措</button>
      <button class="tab" data-step="3" role="tab"><span class="badge">3</span> R：相关方</button>
      <button class="tab" data-step="4" role="tab"><span class="badge">4</span> 输出 & PDF</button>
    </div>

    <!-- STEP 1 -->
    <section id="step1" class="card no-print">
      <h2>Step 1｜S / M / T</h2>

      <div class="grid cols2">
        <div class="card">
          <h3>S（Specific）具体是什么？</h3>
          <div class="field">
            <label for="sSpecific">目标一句话（越具体越好）</label>
            <textarea id="sSpecific" placeholder="例：在8周内完成某课程升级，并在2个班级试点交付。"></textarea>
          </div>
          <div class="hint">建议写清：成果形态 + 场景/对象 + 边界（不做什么）。</div>
        </div>

        <div class="card">
          <h3>T（Time-bound）什么时候达成？</h3>
          <div class="field">
            <label for="tDeadline">截止日期</label>
            <input id="tDeadline" type="date" />
          </div>
          <div class="hint">截止期越近，越需要“快验证”的举措。</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="card">
        <h3>M（Measurable）衡量指标（仅保留：名称 / 基线 / 目标值）</h3>
        <div class="hint">至少 1 条；建议 2-3 条。写清单位（次/份/元/分/人等）。</div>

        <div id="metricsList" class="list" style="margin-top:10px;"></div>

        <div class="btns">
          <button id="addMetric" class="mini">+ 添加指标</button>
          <button id="saveStep1" class="primary">保存并进入 Step 2</button>
        </div>
        <div id="step1Msg" class="hint msg"></div>
      </div>
    </section>

    <!-- STEP 2 -->
    <section id="step2" class="card no-print hidden">
      <h2>Step 2｜A：资源盘点 + 举措（点击“评估”由AI输出概率 + 策略建议）</h2>

      <div class="grid cols2">
        <div class="card">
          <h3>资源盘点（简化字段）</h3>

          <div class="field">
            <label for="resTime">时间：每周可投入小时数</label>
            <input id="resTime" type="number" min="0" step="0.5" placeholder="例如：6" />
          </div>

          <div class="field">
            <label for="resSkills">技能/经验（逗号分隔）</label>
            <textarea id="resSkills" placeholder="例：课程设计, 需求调研, 项目管理, 公众表达"></textarea>
          </div>

          <div class="field">
            <label for="resBudget">预算（元）</label>
            <input id="resBudget" type="number" min="0" step="100" placeholder="例如：2000" />
          </div>

          <div class="field">
            <label for="resTools">工具/信息（逗号分隔）</label>
            <textarea id="resTools" placeholder="例：Notion, 飞书, Excel, 课程平台数据, 录屏设备"></textarea>
          </div>

          <div class="field">
            <label for="resNetwork">可调配的人脉资源（大致数量）</label>
            <input id="resNetwork" type="number" min="0" step="1" placeholder="例如：2" />
            <div class="hint">指你能调动来帮你推进的人：同事、伙伴、导师、关键联系人等。</div>
          </div>

          <div class="field">
            <label for="resEnv">环境支持度（1-10）</label>
            <input id="resEnv" type="range" min="1" max="10" value="6" />
            <div class="hint">
              当前：<span id="resEnvVal" class="mono">6</span>。<br/>
              解释：环境支持度=你所处环境对目标的“放行/协助程度”，包含：权限、流程、资源可得性、组织文化、家庭支持等。分数越高，推进阻力越小。
            </div>
          </div>

          <div class="field">
            <label for="resConstraints">主要限制/摩擦（可选）</label>
            <textarea id="resConstraints" placeholder="例：频繁出差/审批慢/多人协作沟通成本高/注意力易被打断…"></textarea>
          </div>

          <div class="btns">
            <button id="refreshResources" class="mini">更新资源概览</button>
          </div>

          <div id="resourceKpi" class="kpi"></div>
        </div>

        <div class="card">
          <h3>举措清单（至少 3-5 条）</h3>
          <div class="note">
            先按资源来想举措没问题（重点是“如何用资源”）。<br/>
            A评估会检查：<b>举措→指标（M）因果链</b>、<b>资源匹配</b>、<b>关键约束</b>、<b>信息完备度</b>，并给出“成功准备度概率”。
          </div>

          <div id="actionsList" class="list" style="margin-top:10px;"></div>

          <div class="btns">
            <button id="addAction" class="mini">+ 添加举措</button>
            <button id="assessA" class="success">评估举措（A · AI）</button>
            <button id="goStep3" class="primary">进入 Step 3（R）</button>
          </div>

          <!-- 你要求必须显示的错误信息会出现在这里（保留换行） -->
          <div id="step2Msg" class="hint msg"></div>

          <div class="divider"></div>

          <h3>AI策略优化建议（A阶段）</h3>
          <div id="adviceAfterA" class="note">尚未评估。点击“评估举措（A · AI）”后生成。</div>
        </div>
      </div>
    </section>

    <!-- STEP 3 -->
    <section id="step3" class="card no-print hidden">
      <h2>Step 3｜R：相关方（需求 + 互换）→ 回看举措成功概率（AI再评估 + 策略建议）</h2>

      <div class="grid cols2">
        <div class="card">
          <h3>相关方清单</h3>
          <div class="hint">
            这一步的目标：把“TA需要什么”与“互换是否成立（你给的价值是否对齐需求）”说清楚。<br/>
            再评估会输出：每条举措 <b>A → A+R</b> 概率变化、原因，以及下一步对齐动作。
          </div>

          <div id="stakeholdersList" class="list" style="margin-top:10px;"></div>

          <div class="btns">
            <button id="addStakeholder" class="mini">+ 添加相关方</button>
            <button id="reassessAR" class="success">再评估（A+R · AI）</button>
            <button id="goStep4" class="primary">生成输出 & PDF</button>
          </div>

          <div id="step3Msg" class="hint msg"></div>

          <div class="divider"></div>

          <h3>AI策略优化建议（A+R阶段）</h3>
          <div id="adviceAfterAR" class="note">尚未再评估。点击“再评估（A+R · AI）”后生成。</div>
        </div>

        <div class="card">
          <h3>概率对比看板</h3>
          <div id="compareBoard" class="list"></div>
          <div class="divider"></div>
          <div class="note">
            <b>如何用这个看板做理性判断：</b><br/>
            1) 看 <b>关键约束</b>：是谁（资源/截止期/外部依赖/信息缺口）卡住了成功率？<br/>
            2) 看 <b>R带来的变化</b>：外部依赖越高，相关方互换越清晰，概率提升越明显；反之下降也更明显。<br/>
            3) 选策略：优先选“概率更高 + 置信度更高 + 关键约束可被解决”的举措作为主线。
          </div>
        </div>
      </div>
    </section>

    <!-- STEP 4 -->
    <section id="step4" class="card no-print hidden">
      <h2>Step 4｜输出 & 导出 PDF</h2>

      <div class="grid cols2">
        <div class="card">
          <h3>SMART 目标摘要</h3>
          <div id="summaryGoal" class="note"></div>

          <div class="divider"></div>

          <h3>举措排序（按“最新概率”）</h3>
          <div id="summaryActions" class="list"></div>

          <div class="divider"></div>

          <h3>最终策略优化建议（来自AI评估）</h3>
          <div id="finalAdvice" class="note">尚未评估。请完成 A 评估（建议再做 A+R 再评估）。</div>
        </div>

        <div class="card">
          <h3>导出 PDF</h3>
          <div class="note">
            点击“导出PDF”会打开浏览器打印窗口。选择“另存为 PDF”即可。<br/>
            为了排版整洁，PDF将只包含“打印版输出页”的内容。
          </div>

          <div class="btns">
            <button id="exportPdf" class="primary">导出PDF（打印/另存为PDF）</button>
            <button id="copyText" class="mini">复制摘要（纯文本）</button>
            <button id="resetAll" class="danger">重置</button>
          </div>
          <div id="exportMsg" class="hint msg"></div>
        </div>
      </div>
    </section>

    <!-- 打印区 -->
    <section id="printArea" class="hidden"></section>
  </div>

  <script>
    // =========================
    // AI 配置（默认走 Vercel 的 /api/ai）
    // =========================
    const AI_CONFIG = {
      endpoint: "/api/ai",
      timeoutMs: 45000,
      required: true
    };

    // =========================
    // Polyfill（CSS.escape）
    // =========================
    if(!(window.CSS && CSS.escape)){
      window.CSS = window.CSS || {};
      CSS.escape = function(value){
        return String(value).replace(/[^a-zA-Z0-9_\u00A0-\uFFFF-]/g, (ch)=> "\\" + ch);
      };
    }

    // =========================
    // 状态
    // =========================
    const state = {
      goal: { specific:"", deadline:"", metrics:[] },
      resources: {
        timePerWeek: 0,
        skills: "",
        budget: 0,
        tools: "",
        network: 0,
        envSupport: 6,
        constraints: ""
      },
      actions: [],       // {id, content, resourceTypes[], metricId, dependencyMode, stakeholderIds[], A, AR}
      stakeholders: [],  // {id, name, need, expectedSupport, offeredSupport, diag}
      ai: {
        adviceAfterA: null,
        adviceAfterAR: null
      }
    };

    const RESOURCE_TYPES = ["时间","技能/经验","预算","工具/信息","人脉资源","环境支持","其他"];
    const DEP_OPTIONS = ["AUTO","低","中","高"];
    const DEP_LABEL = {AUTO:"自动", "低":"低", "中":"中", "高":"高"};

    // =========================
    // 工具函数
    // =========================
    function uid(){ return (Date.now().toString(36) + Math.random().toString(36).slice(2,8)).toUpperCase(); }
    function clamp(n,a,b){ return Math.min(b, Math.max(a,n)); }
    function toNum(x){ const n = Number(x); return Number.isFinite(n) ? n : 0; }
    function $(id){ return document.getElementById(id); }
    function qs(sel, root=document){ return root.querySelector(sel); }
    function qsa(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function tokenize(s){
      return (s||"")
        .split(/[，,、/；;|\n\t]+/g)
        .map(x => x.trim())
        .filter(Boolean);
    }
    function pct(p){ return Math.round(p*100); }
    function statusByProb01(p){
      if(p >= 0.70) return {cls:"ok", text:"较高"};
      if(p >= 0.45) return {cls:"warn", text:"中等"};
      return {cls:"bad", text:"偏低"};
    }
    function daysToDeadline(dateStr){
      if(!dateStr) return null;
      const d = new Date(dateStr + "T00:00:00");
      if(Number.isNaN(d.getTime())) return null;
      const now = new Date();
      const diff = d.getTime() - now.getTime();
      return Math.floor(diff / (1000*60*60*24));
    }
    function safeJsonExtract(text){
      const raw = (text||"").trim();
      let t = raw.replace(/^```json\s*/i,"").replace(/^```\s*/,"").replace(/```$/,"").trim();
      const firstObj = t.indexOf("{");
      const lastObj = t.lastIndexOf("}");
      if(firstObj !== -1 && lastObj !== -1 && lastObj > firstObj){
        t = t.slice(firstObj, lastObj+1).trim();
      }
      return JSON.parse(t);
    }
    function setBusy(btn, busy, labelBusy){
      if(!btn) return;
      btn.disabled = !!busy;
      const original = btn.dataset.originalText || btn.textContent;
      if(!btn.dataset.originalText) btn.dataset.originalText = original;
      btn.textContent = busy ? (labelBusy || "处理中…") : btn.dataset.originalText;
    }
    function actionTitle(id){
      const a = state.actions.find(x=>x.id===id);
      return a?.content ? a.content : ("（未找到举措 " + (id||"") + "）");
    }
    function renderBullets(arr){
      const items = (Array.isArray(arr)?arr:[]).filter(Boolean);
      if(!items.length) return "<div class='muted'>—</div>";
      return "<ul style='margin:6px 0 0 18px;'>" + items.map(x=>`<li>${escapeHtml(String(x))}</li>`).join("") + "</ul>";
    }

    // =========================
    // Tabs
    // =========================
    const tabs = qsa(".tab");
    function showStep(n){
      qsa("section[id^='step']").forEach(s => s.classList.add("hidden"));
      $("step"+n).classList.remove("hidden");
      tabs.forEach(t => t.classList.toggle("active", t.dataset.step === String(n)));
      window.scrollTo({top:0, behavior:"smooth"});
      if(n === 2){
        collectStep1(); updateMetricOptionsInActions(); updateStakeholderOptionsInActions();
      }
      if(n === 3){
        collectStakeholders(); updateStakeholderOptionsInActions();
        renderCompareBoard();
      }
      if(n === 4){
        renderSummary();
      }
    }
    tabs.forEach(t => t.addEventListener("click", () => showStep(t.dataset.step)));

    // =========================
    // Step 1：M 指标
    // =========================
    function addMetricRow(prefill={}){
      const id = prefill.id || uid();
      const el = document.createElement("div");
      el.className = "item";
      el.dataset.id = id;
      el.innerHTML = `
        <div class="itemhead">
          <strong>指标</strong>
          <button class="mini danger" data-act="removeMetric">删除</button>
        </div>
        <div class="field">
          <label>指标名称</label>
          <input type="text" data-k="name" placeholder="例：课程交付次数/学员满意度/成交额" value="${escapeHtml(prefill.name||"")}" />
        </div>
        <div class="grid cols2">
          <div class="field">
            <label>基线（当前值）</label>
            <input type="text" data-k="baseline" placeholder="例：0 / 4.2分 / 3单" value="${escapeHtml(prefill.baseline||"")}" />
          </div>
          <div class="field">
            <label>目标值（写清单位）</label>
            <input type="text" data-k="target" placeholder="例：8次 / ≥4.6分 / 20单" value="${escapeHtml(prefill.target||"")}" />
          </div>
        </div>
      `;
      el.addEventListener("click", (e)=>{
        if(e.target?.dataset?.act === "removeMetric"){
          el.remove();
          collectStep1();
          updateMetricOptionsInActions();
        }
      });
      el.addEventListener("input", ()=>{
        collectStep1();
        updateMetricOptionsInActions();
      });
      $("metricsList").appendChild(el);
    }
    $("addMetric").addEventListener("click", ()=> addMetricRow());

    function collectStep1(){
      state.goal.specific = $("sSpecific").value.trim();
      state.goal.deadline = $("tDeadline").value;

      const metrics = qsa("#metricsList .item").map(row => ({
        id: row.dataset.id,
        name: (qs("[data-k='name']", row)?.value || "").trim(),
        baseline: (qs("[data-k='baseline']", row)?.value || "").trim(),
        target: (qs("[data-k='target']", row)?.value || "").trim()
      })).filter(m => m.name || m.target || m.baseline);

      state.goal.metrics = metrics;
    }

    function validateStep1(){
      if(!state.goal.specific) return "请填写 S：目标具体是什么。";
      if(!state.goal.deadline) return "请填写 T：截止日期。";
      if(!state.goal.metrics || state.goal.metrics.length < 1) return "请至少填写 1 条 M 指标。";
      const hasTarget = state.goal.metrics.some(m => (m.target||"").length > 0);
      if(!hasTarget) return "至少有一条指标需要填写“目标值”。";
      return "";
    }

    $("saveStep1").addEventListener("click", ()=>{
      collectStep1();
      const msg = validateStep1();
      if(msg){
        $("step1Msg").textContent = msg;
        return;
      }
      $("step1Msg").textContent = "已保存。进入 Step 2：填资源 + 写 3-5 条举措。";
      collectResources();
      renderResourceKpi();
      updateMetricOptionsInActions();
      updateStakeholderOptionsInActions();
      showStep(2);
    });

    // =========================
    // Step 2：资源
    // =========================
    $("resEnv").addEventListener("input", ()=> $("resEnvVal").textContent = $("resEnv").value);

    function collectResources(){
      state.resources.timePerWeek = toNum($("resTime").value);
      state.resources.skills = $("resSkills").value.trim();
      state.resources.budget = toNum($("resBudget").value);
      state.resources.tools = $("resTools").value.trim();
      state.resources.network = toNum($("resNetwork").value);
      state.resources.envSupport = toNum($("resEnv").value);
      state.resources.constraints = $("resConstraints").value.trim();
    }

    function goalClarityScore(){
      let s = 0;
      if(state.goal.specific && state.goal.specific.length >= 10) s += 0.45;
      if(state.goal.deadline) s += 0.25;
      const mOk = (state.goal.metrics||[]).some(m => (m.target||"").length > 0);
      if((state.goal.metrics||[]).length >= 1) s += 0.15;
      if(mOk) s += 0.15;
      return clamp(s, 0, 1);
    }

    function renderResourceKpi(){
      const g = goalClarityScore();
      const days = daysToDeadline(state.goal.deadline);

      const kpis = [
        { v: (state.resources.timePerWeek||0).toFixed(1), t: "时间（小时/周）" },
        { v: String(tokenize(state.resources.skills).length), t: "技能/经验条目数" },
        { v: String(state.resources.budget||0), t: "预算（元）" },
        { v: String(tokenize(state.resources.tools).length), t: "工具/信息条目数" },
        { v: String(state.resources.network||0), t: "人脉资源数量" },
        { v: String(state.resources.envSupport||0) + "/10", t: "环境支持度" },
        { v: pct(g) + "%", t: "目标清晰度（S/M/T）" },
        { v: (days==null ? "—" : (days>=0 ? days+"天" : "已过期")), t: "距截止期" }
      ];

      $("resourceKpi").innerHTML = kpis.map(k => `
        <div class="box">
          <div class="v mono">${escapeHtml(k.v)}</div>
          <div class="t">${escapeHtml(k.t)}</div>
        </div>
      `).join("");
    }

    $("refreshResources").addEventListener("click", ()=>{
      collectResources();
      renderResourceKpi();
    });

    // =========================
    // Step 2：举措（Actions）
    // =========================
    function metricOptionsHtml(selectedId){
      const ms = state.goal.metrics || [];
      const opts = [
        `<option value="">（未选择/不确定）</option>`,
        ...ms.map(m => `<option value="${escapeHtml(m.id)}">${escapeHtml(m.name || ("指标-"+m.id.slice(-4)))}</option>`)
      ];
      return opts.join("");
    }
    function depOptionsHtml(selected){
      const val = selected || "AUTO";
      return DEP_OPTIONS.map(o => `<option value="${o}" ${o===val?"selected":""}>${DEP_LABEL[o]}</option>`).join("");
    }

    function addActionCard(prefill={}){
      const id = prefill.id || uid();
      const el = document.createElement("div");
      el.className = "item";
      el.dataset.id = id;

      el.innerHTML = `
        <div class="itemhead">
          <strong>举措</strong>
          <div style="display:flex; gap:8px; align-items:center;">
            <span class="tag" data-role="tagTop">未评估</span>
            <button class="mini danger" data-act="removeAction">删除</button>
          </div>
        </div>

        <div class="field">
          <label>举措内容（一句话动作即可，建议写成：动作 + 频率 + 交付物）</label>
          <textarea data-k="content" placeholder="例：每周完成2次学员访谈，输出1页洞察并迭代课程结构。">${escapeHtml(prefill.content||"")}</textarea>
        </div>

        <div class="grid cols2">
          <div class="field">
            <label>该举措主要推动哪个指标？（可选，但推荐）</label>
            <select data-k="metricId">${metricOptionsHtml(prefill.metricId||"")}</select>
            <div class="hint">不选也能评估，但AI会更保守（因果链不清）。</div>
          </div>

          <div class="field">
            <label>外部依赖程度（可选，推荐保持“自动”）</label>
            <select data-k="dependencyMode">${depOptionsHtml(prefill.dependencyMode||"AUTO")}</select>
            <div class="hint">用于R阶段影响幅度：依赖越高，相关方互换越能改变成功概率。</div>
          </div>
        </div>

        <div class="field">
          <label>涉及的资源类型（用于评估）</label>
          <div class="checkboxes" data-k="resourceTypes">
            ${RESOURCE_TYPES.map(rt=>{
              const checked = (prefill.resourceTypes||["时间","技能/经验"]).includes(rt) ? "checked" : "";
              return `<label><input type="checkbox" value="${escapeHtml(rt)}" ${checked}/> ${escapeHtml(rt)}</label>`;
            }).join("")}
          </div>
        </div>

        <div class="field">
          <label>关键相关方（可选，1-3个；让R评估更精准）</label>
          <select data-k="stakeholders" multiple size="3"></select>
          <div class="hint">不选也能再评估：AI会用“整体相关方信息”做保守估计。</div>
        </div>

        <div class="divider"></div>

        <div class="twoCol">
          <div class="card" style="margin:0;">
            <h3>A（基于资源）准备度概率</h3>
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div class="mono" style="font-size:18px;" data-role="probA">—</div>
              <span class="tag" data-role="confA">置信度：—</span>
            </div>
            <div class="hrMini"></div>
            <div class="kv" data-role="aDetails">
              <div class="muted">未评估。</div>
            </div>
          </div>

          <div class="card" style="margin:0;">
            <h3>A+R（加入相关方）准备度概率</h3>
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div class="mono" style="font-size:18px;" data-role="probAR">—</div>
              <span class="tag" data-role="deltaAR">变化：—</span>
            </div>
            <div class="hrMini"></div>
            <div class="kv" data-role="arDetails">
              <div class="muted">未评估。</div>
            </div>
          </div>
        </div>
      `;

      el.addEventListener("click", (e)=>{
        if(e.target?.dataset?.act === "removeAction"){
          el.remove();
          state.actions = state.actions.filter(a => a.id !== id);
          renderCompareBoard();
        }
      });

      el.addEventListener("input", collectActions);
      el.addEventListener("change", collectActions);

      $("actionsList").appendChild(el);

      if(!state.actions.some(a => a.id === id)){
        state.actions.push({
          id,
          content: prefill.content || "",
          resourceTypes: prefill.resourceTypes || ["时间","技能/经验"],
          metricId: prefill.metricId || "",
          dependencyMode: prefill.dependencyMode || "AUTO",
          stakeholderIds: prefill.stakeholderIds || [],
          A: null,
          AR: null
        });
      }

      updateMetricOptionsInActions();
      updateStakeholderOptionsInActions();
    }

    $("addAction").addEventListener("click", ()=>{
      addActionCard();
      $("step2Msg").textContent = "已添加举措。建议保持 3-5 条用于选择。";
    });

    function updateMetricOptionsInActions(){
      qsa("#actionsList .item").forEach(el=>{
        const id = el.dataset.id;
        const a = state.actions.find(x=>x.id===id);
        if(!a) return;
        const sel = qs("select[data-k='metricId']", el);
        if(!sel) return;
        const prev = a.metricId || "";
        sel.innerHTML = metricOptionsHtml(prev);
        sel.value = prev;
      });
    }

    function updateStakeholderOptionsInActions(){
      collectStakeholders();
      const options = (state.stakeholders||[]).map(s => ({id:s.id, label: s.name || ("未命名相关方 " + s.id.slice(-4))}));
      qsa("#actionsList .item").forEach(el=>{
        const id = el.dataset.id;
        const a = state.actions.find(x=>x.id===id);
        if(!a) return;
        const sel = qs("select[data-k='stakeholders']", el);
        if(!sel) return;

        const prev = new Set(a.stakeholderIds || []);
        sel.innerHTML = options.map(o => `<option value="${escapeHtml(o.id)}">${escapeHtml(o.label)}</option>`).join("");
        Array.from(sel.options).forEach(opt => opt.selected = prev.has(opt.value));
      });
    }

    function collectActions(){
      qsa("#actionsList .item").forEach(el=>{
        const id = el.dataset.id;
        const a = state.actions.find(x => x.id === id);
        if(!a) return;

        a.content = (qs("textarea[data-k='content']", el)?.value || "").trim();
        a.metricId = (qs("select[data-k='metricId']", el)?.value || "").trim();
        a.dependencyMode = (qs("select[data-k='dependencyMode']", el)?.value || "AUTO").trim();

        a.resourceTypes = qsa("[data-k='resourceTypes'] input[type='checkbox']", el)
          .filter(c => c.checked)
          .map(c => c.value);

        const sel = qs("select[data-k='stakeholders']", el);
        a.stakeholderIds = Array.from(sel?.selectedOptions || []).map(o => o.value);
      });
    }

    function validateForAssessA(){
      collectStep1();
      const msg1 = validateStep1();
      if(msg1) return msg1;

      collectResources();
      collectActions();

      if(state.actions.length < 3) return "举措太少：请至少写 3 条（建议 3-5 条）。";
      const filled = state.actions.filter(a => (a.content||"").trim().length > 0).length;
      if(filled < 3) return "请至少写满 3 条举措内容（每条一句话）。";
      return "";
    }

    // =========================
    // Step 3：相关方
    // =========================
    function addStakeholderCard(prefill={}){
      const id = prefill.id || uid();
      const el = document.createElement("div");
      el.className = "item";
      el.dataset.id = id;

      el.innerHTML = `
        <div class="itemhead">
          <strong>相关方</strong>
          <div style="display:flex; gap:8px; align-items:center;">
            <span class="tag" data-role="shTag">未诊断</span>
            <button class="mini danger" data-act="removeStakeholder">删除</button>
          </div>
        </div>

        <div class="field">
          <label>相关方是谁（姓名/角色/部门）</label>
          <input type="text" data-k="name" placeholder="例：直属领导 / 业务负责人 / 合作伙伴" value="${escapeHtml(prefill.name||"")}" />
        </div>

        <div class="field">
          <label>TA的需求（只填“需求”）</label>
          <textarea data-k="need" placeholder="例：希望风险可控、过程透明、结果可验证…">${escapeHtml(prefill.need||"")}</textarea>
        </div>

        <div class="grid cols2">
          <div class="field">
            <label>你希望TA给到哪些支持？（越具体越好）</label>
            <textarea data-k="expectedSupport" placeholder="例：给试点授权/协调资源/每周10分钟review…">${escapeHtml(prefill.expectedSupport||"")}</textarea>
          </div>
          <div class="field">
            <label>你能给TA哪些支持？（对齐TA需求）</label>
            <textarea data-k="offeredSupport" placeholder="例：提供试点数据复盘/交付模板/降低TA的交付压力…">${escapeHtml(prefill.offeredSupport||"")}</textarea>
          </div>
        </div>

        <div class="hrMini"></div>
        <div class="kv" data-role="shDiag">
          <div class="muted">尚未诊断（点击“再评估 A+R · AI”会自动诊断）。</div>
        </div>
      `;

      el.addEventListener("click", (e)=>{
        if(e.target?.dataset?.act === "removeStakeholder"){
          el.remove();
          state.stakeholders = state.stakeholders.filter(s => s.id !== id);
          state.actions.forEach(a => a.stakeholderIds = (a.stakeholderIds||[]).filter(sid => sid !== id));
          updateStakeholderOptionsInActions();
          renderCompareBoard();
        }
      });

      el.addEventListener("input", ()=>{
        collectStakeholders();
        updateStakeholderOptionsInActions();
      });

      $("stakeholdersList").appendChild(el);

      if(!state.stakeholders.some(s => s.id === id)){
        state.stakeholders.push({
          id,
          name: prefill.name || "",
          need: prefill.need || "",
          expectedSupport: prefill.expectedSupport || "",
          offeredSupport: prefill.offeredSupport || "",
          diag: null
        });
      }

      updateStakeholderOptionsInActions();
    }

    $("addStakeholder").addEventListener("click", ()=>{
      addStakeholderCard();
      $("step3Msg").textContent = "已添加相关方。建议至少写 1-3 个关键相关方。";
    });

    function collectStakeholders(){
      qsa("#stakeholdersList .item").forEach(el=>{
        const id = el.dataset.id;
        const s = state.stakeholders.find(x=>x.id===id);
        if(!s) return;
        s.name = (qs("[data-k='name']", el)?.value || "").trim();
        s.need = (qs("textarea[data-k='need']", el)?.value || "").trim();
        s.expectedSupport = (qs("textarea[data-k='expectedSupport']", el)?.value || "").trim();
        s.offeredSupport = (qs("textarea[data-k='offeredSupport']", el)?.value || "").trim();
      });
    }

    function paintStakeholderDiagFromAI(sid, diag){
      const el = qs(`#stakeholdersList .item[data-id='${CSS.escape(sid)}']`);
      if(!el) return;
      const tag = qs("[data-role='shTag']", el);
      const host = qs("[data-role='shDiag']", el);

      const likelihood = diag?.support_likelihood || "—";
      const cls = likelihood==="高" ? "ok" : (likelihood==="中" ? "warn" : "bad");
      tag.className = `tag ${cls}`;
      tag.textContent = `支持可能性：${likelihood}`;

      const risks = (diag?.risks || []).join("；") || "—";
      const improves = (diag?.improve_suggestions || []).join("；") || "—";

      host.innerHTML = `
        <div><b>需求清晰</b>：${escapeHtml(String(diag?.need_clarity_0to5 ?? "—"))}/5</div>
        <div><b>互换成立</b>：${escapeHtml(String(diag?.exchange_fit_0to5 ?? "—"))}/5</div>
        <div><b>请求可执行</b>：${escapeHtml(String(diag?.ask_executable_0to5 ?? "—"))}/5</div>
        <div class="hrMini"></div>
        <div><b>风险</b>：${escapeHtml(risks)}</div>
        <div><b>改进建议</b>：${escapeHtml(improves)}</div>
      `;
    }

    // =========================
    // UI：渲染举措评估结果
    // =========================
    function paintActionCardFromState(actionId){
      const el = qs(`#actionsList .item[data-id='${CSS.escape(actionId)}']`);
      if(!el) return;
      const a = state.actions.find(x=>x.id===actionId);
      if(!a) return;

      const tagTop = qs("[data-role='tagTop']", el);
      const probAEl = qs("[data-role='probA']", el);
      const confAEl = qs("[data-role='confA']", el);
      const aDetails = qs("[data-role='aDetails']", el);

      const probAREl = qs("[data-role='probAR']", el);
      const deltaAREl = qs("[data-role='deltaAR']", el);
      const arDetails = qs("[data-role='arDetails']", el);

      // A
      if(a.A){
        const pA = clamp((a.A.success_probability_percent||0)/100, 0.05, 0.90);
        const st = statusByProb01(pA);
        tagTop.className = `tag ${st.cls}`;
        tagTop.textContent = `A：${pct(pA)}%`;

        probAEl.textContent = `${pct(pA)}%`;

        const conf = a.A.confidence_level || "—";
        confAEl.className = `tag ${conf==="高"?"ok":(conf==="中"?"warn":"bad")}`;
        confAEl.textContent = `置信度：${conf}`;

        const metric = (a.A.cause_to_metrics?.[0]?.metric) || "（未说明）";
        const strength = (a.A.cause_to_metrics?.[0]?.strength_0to5 ?? "—");

        const keyConstraint = a.A.key_constraint || "—";
        const missing = (a.A.missing_info||[]).slice(0,6).join("；") || "—";
        const levers = (a.A.next_levers||[]).slice(0,5).join("；") || "—";

        const strongRes = (a.A.resource_fit||[]).filter(r => (r.fit_0to5 ?? 0) >= 3.5).map(r => `${r.resource}(${r.fit_0to5}/5)`).join("、") || "—";
        const weakRes = (a.A.resource_fit||[]).filter(r => (r.fit_0to5 ?? 5) <= 2.0).map(r => `${r.resource}(${r.fit_0to5}/5)`).join("、") || "—";

        aDetails.innerHTML = `
          <div><b>因果链</b>：${escapeHtml(metric)}（强度 ${escapeHtml(String(strength))}/5）</div>
          <div><b>关键约束</b>：${escapeHtml(keyConstraint)}</div>
          <div><b>资源强项</b>：${escapeHtml(strongRes)}</div>
          <div><b>资源短板</b>：${escapeHtml(weakRes)}</div>
          <div class="hrMini"></div>
          <div><b>缺口</b>：${escapeHtml(missing)}</div>
          <div><b>提升杠杆</b>：${escapeHtml(levers)}</div>
        `;
      }else{
        tagTop.className = "tag";
        tagTop.textContent = "未评估";
        probAEl.textContent = "—";
        confAEl.className = "tag";
        confAEl.textContent = "置信度：—";
        aDetails.innerHTML = `<div class="muted">未评估。</div>`;
      }

      // A+R
      if(a.AR){
        const pAR = clamp((a.AR.probAR_percent||0)/100, 0.05, 0.90);
        probAREl.textContent = `${pct(pAR)}%`;

        const delta = (a.AR.delta_percent ?? null);
        if(delta == null){
          deltaAREl.className = "tag";
          deltaAREl.textContent = "变化：—";
        }else{
          deltaAREl.className = `tag ${delta>=0 ? "ok" : "bad"}`;
          deltaAREl.textContent = `变化：${delta>=0?"+":""}${Math.round(delta)}%`;
        }

        const dep = a.AR.dependency_level || "—";
        const ks = (a.AR.key_stakeholders || []).join("、") || "（未绑定/未填写）";
        const why = (a.AR.why_changed || []).join("；") || "—";
        const moves = (a.AR.next_alignment_moves || []).join("；") || "—";

        arDetails.innerHTML = `
          <div><b>依赖度</b>：${escapeHtml(dep)}（依赖越高，R影响越大）</div>
          <div><b>关键相关方</b>：${escapeHtml(ks)}</div>
          <div><b>变化原因</b>：${escapeHtml(why)}</div>
          <div class="hrMini"></div>
          <div><b>下一步对齐动作</b>：${escapeHtml(moves)}</div>
        `;
      }else{
        probAREl.textContent = "—";
        deltaAREl.className = "tag";
        deltaAREl.textContent = "变化：—";
        arDetails.innerHTML = `<div class="muted">未评估。</div>`;
      }
    }

    // =========================
    // AI 调用层（/api/ai）
    // =========================
    async function aiChat(messages, meta={}){
      if(typeof window.AI_EVALUATE === "function"){
        return await window.AI_EVALUATE(messages, meta);
      }

      if(AI_CONFIG.endpoint){
        const controller = new AbortController();
        const timer = setTimeout(()=>controller.abort(), AI_CONFIG.timeoutMs);

        try{
          const res = await fetch(AI_CONFIG.endpoint, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ messages, meta }),
            signal: controller.signal
          });
          const json = await res.json();
          if(!res.ok) throw new Error(json?.error || ("HTTP " + res.status));
          if(typeof json?.content !== "string") throw new Error("AI响应格式错误：缺少content字段");
          return json.content;
        } finally {
          clearTimeout(timer);
        }
      }

      throw new Error("AI未配置：请注入 window.AI_EVALUATE(messages) 或配置 AI_CONFIG.endpoint（后端代理）。");
    }

    // =========================
    // A 评估：payload + prompt
    // =========================
    function buildPayloadForA(){
      const g = state.goal;
      const r = state.resources;

      const metrics = (g.metrics||[]).map(m=>({
        id: m.id,
        name: m.name || "",
        baseline: m.baseline || "",
        target: m.target || ""
      }));

      const stakeholdersById = new Map((state.stakeholders||[]).map(s => [s.id, s]));

      const actions = state.actions.map(a=>{
        const metric = (g.metrics||[]).find(m => m.id === a.metricId);
        const ks = (a.stakeholderIds||[]).map(id => stakeholdersById.get(id)).filter(Boolean).map(s => s.name || s.id);
        return {
          id: a.id,
          content: a.content || "",
          resourceTypes: a.resourceTypes || [],
          metric_hint: metric ? (metric.name || metric.id) : "",
          dependency_hint: a.dependencyMode || "AUTO",
          key_stakeholders_hint: ks
        };
      });

      return {
        today: new Date().toISOString().slice(0,10),
        goal: {
          S: g.specific || "",
          T_deadline: g.deadline || "",
          M_metrics: metrics
        },
        resources: {
          timePerWeekHours: r.timePerWeek,
          skillsExperience: r.skills,
          budgetYuan: r.budget,
          toolsInfo: r.tools,
          networkCount: r.network,
          envSupport_1to10: r.envSupport,
          constraintsOptional: r.constraints
        },
        actions
      };
    }

    function buildMessagesForA(payload){
      const system = [
        "你是一名“目标管理与落地执行”专家。",
        "你的任务：评估用户每条举措在当前SMART与资源条件下的“成功准备度概率（readiness probability）”，并给出跨举措的策略优化建议。",
        "原则：输出谨慎；信息缺失要写缺口并降低置信度；不要过度乐观；概率建议落在5~90之间。",
        "评估必须包含目标管理视角：举措→指标(M)因果链强度、资源匹配度、截止期下见效速度、外部依赖与可控性、信息完备度。",
        "输出必须是严格 JSON，不要输出任何多余文字。"
      ].join("\n");

      const user = [
        "请对输入中的每条举措做 A（可达成性）评估，并额外输出“策略优化建议（A阶段）”。",
        "",
        "【输入数据JSON】",
        JSON.stringify(payload, null, 2),
        "",
        "【输出JSON schema】",
        JSON.stringify({
          goal_clarity_check: {
            S_ok: true,
            M_ok: true,
            T_ok: true,
            main_ambiguities: ["..."]
          },
          actions_A_assessment: [
            {
              action_id: "（必须与输入actions.id完全一致）",
              success_probability_percent: 0,
              confidence_level: "高/中/低",
              cause_to_metrics: [
                { metric: "指标名称或（未指定）", strength_0to5: 0, reason: "简短原因" }
              ],
              resource_fit: [
                { resource: "时间/技能/经验/预算/工具/信息/人脉资源/环境支持/其他", fit_0to5: 0, gap: "若无缺口可为空字符串" }
              ],
              key_constraint: "最可能卡死该举措的单点瓶颈（只写1条）",
              missing_info: ["信息缺口1","信息缺口2"],
              next_levers: ["最有效提升动作1","提升动作2"]
            }
          ],
          strategy_advice_after_A: {
            mainline_actions: [
              { action_id: "id", why: "为什么适合做主线（结合资源与指标）" }
            ],
            backup_actions: [
              { action_id: "id", why: "为什么适合作为备选（条件/触发器）" }
            ],
            actions_to_rewrite: [
              { action_id: "id", why: "为什么需要重写/拆分（缺口/约束/因果链弱）" }
            ],
            cross_action_suggestions: ["跨举措的结构性建议（3-7条）"],
            next_7_days_plan: ["未来7天最优先执行计划（3-5条）"]
          }
        }, null, 2),
        "",
        "【硬性要求】",
        "1) action_id 必须原样返回，用于回填UI；不要新增/改写id。",
        "2) missing_info 与 next_levers 需短句可执行，最多各3条。",
        "3) success_probability_percent 为整数 0~100（建议5~90）。",
        "4) strategy_advice_after_A 中的 action_id 只能引用输入中的 actions.id。"
      ].join("\n");

      return [
        {role:"system", content: system},
        {role:"user", content: user}
      ];
    }

    // =========================
    // R 再评估：payload + prompt
    // =========================
    function buildPayloadForAR(){
      const g = state.goal;

      const actionsA = state.actions.map(a=>{
        const pA = a.A?.success_probability_percent ?? null;
        return {
          id: a.id,
          content: a.content || "",
          resourceTypes: a.resourceTypes || [],
          metric_hint: (g.metrics||[]).find(m => m.id === a.metricId)?.name || "",
          dependency_hint: a.dependencyMode || "AUTO",
          bound_stakeholders: (a.stakeholderIds||[]).map(sid => state.stakeholders.find(s=>s.id===sid)?.name).filter(Boolean),
          probA_percent: pA
        };
      });

      const stakeholders = state.stakeholders.map(s=>({
        stakeholder_id: s.id,
        name: s.name || "",
        need: s.need || "",
        expected_support: s.expectedSupport || "",
        offered_support: s.offeredSupport || ""
      }));

      return {
        today: new Date().toISOString().slice(0,10),
        goal_hint: {
          S: state.goal.specific || "",
          T_deadline: state.goal.deadline || "",
          M_metrics: (state.goal.metrics||[]).map(m => ({name:m.name, baseline:m.baseline, target:m.target}))
        },
        actionsA,
        stakeholders
      };
    }

    function buildMessagesForAR(payload){
      const system = [
        "你是一名“相关方对齐与策略落地”专家。",
        "你要在 A 阶段评估基础上，利用相关方信息重新评估每条举措成功准备度概率（A+R），并给出最终策略优化建议。",
        "只有当“需求清晰 + 互换成立 + 支持具体可执行”时才应上调；反之应保守甚至下调。",
        "外部依赖越高（人脉/环境/审批/跨部门/合作），R的影响幅度应越大。",
        "输出必须是严格 JSON，不要输出任何多余文字。"
      ].join("\n");

      const user = [
        "请基于输入数据，完成：相关方诊断 + 每条举措 A+R 再评估 + 策略优化建议（A+R阶段）。",
        "",
        "【输入数据JSON】",
        JSON.stringify(payload, null, 2),
        "",
        "【输出JSON schema】",
        JSON.stringify({
          stakeholders_diagnosis: [
            {
              stakeholder_id: "（必须与输入stakeholders.stakeholder_id一致）",
              name: "相关方名称",
              need_clarity_0to5: 0,
              exchange_fit_0to5: 0,
              ask_executable_0to5: 0,
              support_likelihood: "高/中/低",
              risks: ["..."],
              improve_suggestions: ["..."]
            }
          ],
          actions_AR_reassessment: [
            {
              action_id: "（必须与输入actionsA.id完全一致）",
              probA_percent: 0,
              probAR_percent: 0,
              delta_percent: 0,
              dependency_level: "高/中/低",
              key_stakeholders: ["名称1","名称2"],
              why_changed: ["..."],
              next_alignment_moves: ["..."]
            }
          ],
          strategy_advice_after_AR: {
            updated_mainline_actions: [
              { action_id: "id", why: "为什么成为最终主线（结合A+R概率变化）" }
            ],
            updated_backup_actions: [
              { action_id: "id", why: "作为备选的触发条件/前提" }
            ],
            actions_to_pause_or_rewrite: [
              { action_id: "id", why: "为什么需要暂停/重写（共识不足/互换不成立/风险高）" }
            ],
            stakeholder_alignment_plan: [
              {
                stakeholder_name: "谁",
                ask: "你要对方提供什么支持（具体可执行）",
                give: "你提供什么（对齐需求）",
                first_step: "第一步沟通动作（时间/方式/交付物）"
              }
            ],
            cross_action_suggestions: ["跨举措的结构性建议（3-7条）"],
            next_7_days_plan: ["未来7天最优先执行计划（3-5条）"]
          }
        }, null, 2),
        "",
        "【硬性要求】",
        "1) stakeholder_id / action_id 必须原样返回，用于回填UI；不要新增/改写id。",
        "2) delta_percent = probAR_percent - probA_percent（整数）。",
        "3) why_changed / next_alignment_moves / plan 字段最多各3-5条，短句可执行。",
        "4) strategy_advice_after_AR 中 action_id 只能引用输入中的 actionsA.id。"
      ].join("\n");

      return [
        {role:"system", content: system},
        {role:"user", content: user}
      ];
    }

    // =========================
    // 策略建议渲染
    // =========================
    function renderAdviceAfterA(){
      const box = $("adviceAfterA");
      const adv = state.ai.adviceAfterA;
      if(!adv){ box.innerHTML = "尚未评估。点击“评估举措（A · AI）”后生成。"; return; }

      const main = (adv.mainline_actions||[]).map(x => `【主线】${actionTitle(x.action_id)} —— ${x.why||""}`);
      const backup = (adv.backup_actions||[]).map(x => `【备选】${actionTitle(x.action_id)} —— ${x.why||""}`);
      const rewrite = (adv.actions_to_rewrite||[]).map(x => `【重写】${actionTitle(x.action_id)} —— ${x.why||""}`);

      box.innerHTML = `
        <div><b>主线/备选/重写建议</b></div>
        ${renderBullets([...main, ...backup, ...rewrite])}
        <div style="margin-top:10px;"><b>跨举措结构性建议</b></div>
        ${renderBullets(adv.cross_action_suggestions)}
        <div style="margin-top:10px;"><b>未来7天计划</b></div>
        ${renderBullets(adv.next_7_days_plan)}
      `;
    }

    function renderAdviceAfterAR(){
      const box = $("adviceAfterAR");
      const adv = state.ai.adviceAfterAR;
      if(!adv){ box.innerHTML = "尚未再评估。点击“再评估（A+R · AI）”后生成。"; return; }

      const main = (adv.updated_mainline_actions||[]).map(x => `【最终主线】${actionTitle(x.action_id)} —— ${x.why||""}`);
      const backup = (adv.updated_backup_actions||[]).map(x => `【最终备选】${actionTitle(x.action_id)} —— ${x.why||""}`);
      const pause = (adv.actions_to_pause_or_rewrite||[]).map(x => `【暂停/重写】${actionTitle(x.action_id)} —— ${x.why||""}`);

      const planLines = (adv.stakeholder_alignment_plan||[]).map(p=>{
        const who = p.stakeholder_name || "（未写）";
        return `对齐【${who}】：要支持=${p.ask||"—"}；我提供=${p.give||"—"}；第一步=${p.first_step||"—"}`;
      });

      box.innerHTML = `
        <div><b>最终主线/备选/暂停建议</b></div>
        ${renderBullets([...main, ...backup, ...pause])}
        <div style="margin-top:10px;"><b>相关方对齐计划</b></div>
        ${renderBullets(planLines)}
        <div style="margin-top:10px;"><b>跨举措结构性建议</b></div>
        ${renderBullets(adv.cross_action_suggestions)}
        <div style="margin-top:10px;"><b>未来7天计划</b></div>
        ${renderBullets(adv.next_7_days_plan)}
      `;
    }

    function renderFinalAdvice(){
      const box = $("finalAdvice");
      const advAR = state.ai.adviceAfterAR;
      const advA = state.ai.adviceAfterA;

      if(advAR){
        const main = (advAR.updated_mainline_actions||[]).map(x => `【最终主线】${actionTitle(x.action_id)} —— ${x.why||""}`);
        const backup = (advAR.updated_backup_actions||[]).map(x => `【最终备选】${actionTitle(x.action_id)} —— ${x.why||""}`);
        const pause = (advAR.actions_to_pause_or_rewrite||[]).map(x => `【暂停/重写】${actionTitle(x.action_id)} —— ${x.why||""}`);

        const planLines = (advAR.stakeholder_alignment_plan||[]).map(p=>{
          const who = p.stakeholder_name || "（未写）";
          return `对齐【${who}】：要支持=${p.ask||"—"}；我提供=${p.give||"—"}；第一步=${p.first_step||"—"}`;
        });

        box.innerHTML = `
          <div><b>最终策略（优先基于 A+R）</b></div>
          ${renderBullets([...main, ...backup, ...pause])}
          <div style="margin-top:10px;"><b>相关方对齐计划</b></div>
          ${renderBullets(planLines)}
          <div style="margin-top:10px;"><b>跨举措结构性建议</b></div>
          ${renderBullets(advAR.cross_action_suggestions)}
          <div style="margin-top:10px;"><b>未来7天计划</b></div>
          ${renderBullets(advAR.next_7_days_plan)}
        `;
        return;
      }

      if(advA){
        const main = (advA.mainline_actions||[]).map(x => `【主线】${actionTitle(x.action_id)} —— ${x.why||""}`);
        const backup = (advA.backup_actions||[]).map(x => `【备选】${actionTitle(x.action_id)} —— ${x.why||""}`);
        const rewrite = (advA.actions_to_rewrite||[]).map(x => `【重写】${actionTitle(x.action_id)} —— ${x.why||""}`);

        box.innerHTML = `
          <div><b>策略建议（仅完成 A 评估）</b></div>
          ${renderBullets([...main, ...backup, ...rewrite])}
          <div style="margin-top:10px;"><b>跨举措结构性建议</b></div>
          ${renderBullets(advA.cross_action_suggestions)}
          <div style="margin-top:10px;"><b>未来7天计划</b></div>
          ${renderBullets(advA.next_7_days_plan)}
          <div class="hint" style="margin-top:8px;">提示：若你的举措依赖“人脉资源/环境支持”，强烈建议补齐 R 并做 A+R 再评估。</div>
        `;
        return;
      }

      box.textContent = "尚未评估。请完成 A 评估（建议再做 A+R 再评估）。";
    }

    // =========================
    // A 评估按钮
    // =========================
    function showAssessErrorA(e){
      $("step2Msg").textContent =
        "AI评估失败（未回填结果）。请检查AI接入配置与返回JSON格式。\n" +
        "错误：" + (e?.message || e);
      console.error(e);
    }

    $("assessA").addEventListener("click", async ()=>{
      const btn = $("assessA");
      const msg = validateForAssessA();
      if(msg){
        $("step2Msg").textContent = msg;
        return;
      }

      collectResources();
      renderResourceKpi();
      updateStakeholderOptionsInActions();

      const payload = buildPayloadForA();
      const messages = buildMessagesForA(payload);

      $("step2Msg").textContent = "AI评估中：正在输出每条举措的成功准备度概率、置信度、关键约束、提升杠杆与策略优化建议…";
      setBusy(btn, true, "AI评估中…");

      try{
        const text = await aiChat(messages, {type:"A_assessment"});
        const json = safeJsonExtract(text);

        const arr = Array.isArray(json?.actions_A_assessment) ? json.actions_A_assessment : [];
        const map = new Map(arr.map(x => [x.action_id, x]));

        state.actions.forEach(a=>{
          const out = map.get(a.id);
          if(!out) return;
          a.AR = null;
          const prob = clamp(Number(out.success_probability_percent ?? 0), 0, 100);
          a.A = {
            success_probability_percent: Math.round(prob),
            confidence_level: (out.confidence_level || "中").replace(/\s/g,""),
            cause_to_metrics: Array.isArray(out.cause_to_metrics) ? out.cause_to_metrics : [],
            resource_fit: Array.isArray(out.resource_fit) ? out.resource_fit : [],
            key_constraint: String(out.key_constraint || "—"),
            missing_info: Array.isArray(out.missing_info) ? out.missing_info : [],
            next_levers: Array.isArray(out.next_levers) ? out.next_levers : []
          };
        });

        state.ai.adviceAfterA = json?.strategy_advice_after_A || null;
        renderAdviceAfterA();
        renderFinalAdvice();

        state.actions.forEach(a => paintActionCardFromState(a.id));
        renderCompareBoard();

        $("step2Msg").textContent = "A评估完成：已生成概率与“策略优化建议（A阶段）”。建议进入 Step 3 补齐相关方后再评估（A+R）。";
      }catch(e){
        showAssessErrorA(e);
      }finally{
        setBusy(btn, false);
      }
    });

    $("goStep3").addEventListener("click", ()=>{
      collectStep1(); collectResources(); collectActions(); collectStakeholders();
      updateStakeholderOptionsInActions();
      showStep(3);
    });

    // =========================
    // A+R 再评估按钮
    // =========================
    function showAssessErrorAR(e){
      $("step3Msg").textContent =
        "AI评估失败（未回填结果）。请检查AI接入配置与返回JSON格式。\n" +
        "错误：" + (e?.message || e);
      console.error(e);
    }

    $("reassessAR").addEventListener("click", async ()=>{
      const btn = $("reassessAR");
      collectStep1(); collectResources(); collectActions(); collectStakeholders();

      const needA = state.actions.some(a => !a.A);
      if(needA){
        $("step3Msg").textContent = "请先回到 Step 2 点击“评估举措（A · AI）”，再做 A+R 再评估。";
        return;
      }

      updateStakeholderOptionsInActions();

      const payload = buildPayloadForAR();
      const messages = buildMessagesForAR(payload);

      $("step3Msg").textContent = "AI再评估中：正在诊断相关方（需求/互换/可执行性），并回看每条举措 A→A+R 概率变化 + 策略优化建议…";
      setBusy(btn, true, "AI再评估中…");

      try{
        const text = await aiChat(messages, {type:"AR_reassessment"});
        const json = safeJsonExtract(text);

        const shArr = Array.isArray(json?.stakeholders_diagnosis) ? json.stakeholders_diagnosis : [];
        const shMap = new Map(shArr.map(x => [x.stakeholder_id, x]));
        state.stakeholders.forEach(s=>{
          const d = shMap.get(s.id);
          if(!d) return;
          s.diag = {
            need_clarity_0to5: d.need_clarity_0to5,
            exchange_fit_0to5: d.exchange_fit_0to5,
            ask_executable_0to5: d.ask_executable_0to5,
            support_likelihood: d.support_likelihood,
            risks: Array.isArray(d.risks) ? d.risks : [],
            improve_suggestions: Array.isArray(d.improve_suggestions) ? d.improve_suggestions : []
          };
          paintStakeholderDiagFromAI(s.id, s.diag);
        });

        const arArr = Array.isArray(json?.actions_AR_reassessment) ? json.actions_AR_reassessment : [];
        const arMap = new Map(arArr.map(x => [x.action_id, x]));

        state.actions.forEach(a=>{
          const out = arMap.get(a.id);
          if(!out) return;

          a.AR = {
            probA_percent: Number(out.probA_percent ?? (a.A?.success_probability_percent ?? 0)),
            probAR_percent: Math.round(clamp(Number(out.probAR_percent ?? 0), 0, 100)),
            delta_percent: Math.round(Number(out.delta_percent ?? 0)),
            dependency_level: String(out.dependency_level || "中").replace(/\s/g,""),
            key_stakeholders: Array.isArray(out.key_stakeholders) ? out.key_stakeholders : [],
            why_changed: Array.isArray(out.why_changed) ? out.why_changed : [],
            next_alignment_moves: Array.isArray(out.next_alignment_moves) ? out.next_alignment_moves : []
          };
        });

        state.ai.adviceAfterAR = json?.strategy_advice_after_AR || null;
        renderAdviceAfterAR();
        renderFinalAdvice();

        state.actions.forEach(a => paintActionCardFromState(a.id));
        renderCompareBoard();

        $("step3Msg").textContent = "A+R 再评估完成：已生成概率变化与“策略优化建议（A+R阶段）”。";
      }catch(e){
        showAssessErrorAR(e);
      }finally{
        setBusy(btn, false);
      }
    });

    // =========================
    // 对比看板
    // =========================
    function renderCompareBoard(){
      const host = $("compareBoard");
      if(!host) return;

      const rows = state.actions.map(a=>{
        const pA = a.A ? clamp(a.A.success_probability_percent/100, 0.05, 0.90) : null;
        const pAR = a.AR ? clamp(a.AR.probAR_percent/100, 0.05, 0.90) : null;
        const latest = (pAR ?? pA);
        const delta = (a.AR && a.A) ? (a.AR.delta_percent) : null;
        const constraint = a.A?.key_constraint || "—";
        const conf = a.A?.confidence_level || "—";
        return { id:a.id, content:a.content||"（未填写举措）", pA, pAR, latest, delta, constraint, conf };
      }).sort((x,y)=> (y.latest ?? -1) - (x.latest ?? -1));

      if(rows.length === 0){
        host.innerHTML = `<div class="hint">暂无举措。</div>`;
        return;
      }

      host.innerHTML = rows.map(r=>{
        const latest = r.latest ?? 0;
        const st = statusByProb01(latest);
        const aTxt = (r.pA==null) ? "—" : (pct(r.pA)+"%");
        const arTxt = (r.pAR==null) ? "—" : (pct(r.pAR)+"%");
        const dTxt = (r.delta==null) ? "变化：—" : `变化：${r.delta>=0?"+":""}${Math.round(r.delta)}%`;
        return `
          <div class="item">
            <div class="itemhead">
              <strong>${escapeHtml(r.content)}</strong>
              <span class="tag ${st.cls}">最新：${pct(latest)}%</span>
            </div>
            <div class="hint">
              A：<span class="mono">${escapeHtml(aTxt)}</span>
              &nbsp;｜&nbsp;
              A+R：<span class="mono">${escapeHtml(arTxt)}</span>
              &nbsp;｜&nbsp;
              <span class="muted">${escapeHtml(dTxt)}</span>
            </div>
            <div class="hint">
              <span class="muted">置信度：</span><span class="mono">${escapeHtml(r.conf)}</span>
              &nbsp;｜&nbsp;
              <span class="muted">关键约束：</span>${escapeHtml(r.constraint)}
            </div>
          </div>
        `;
      }).join("");
    }

    // =========================
    // Step4：摘要 + 打印
    // =========================
    function renderSummary(){
      collectStep1(); collectResources(); collectActions(); collectStakeholders();

      const g = state.goal;
      const metricsHtml = (g.metrics||[]).map(m => {
        const name = m.name || "（未命名指标）";
        const base = m.baseline ? `基线：${m.baseline}` : "基线：—";
        const targ = m.target ? `目标：${m.target}` : "目标：—";
        return `• ${escapeHtml(name)}（${escapeHtml(base)}；${escapeHtml(targ)}）`;
      }).join("<br/>") || "•（暂无指标）";

      $("summaryGoal").innerHTML = `
        <b>S</b>：${escapeHtml(g.specific || "（未填写）")}<br/><br/>
        <b>M</b>：<br/>${metricsHtml}<br/><br/>
        <b>T</b>：<span class="mono">${escapeHtml(g.deadline || "（未设置）")}</span>
      `;

      const sorted = state.actions.map(a=>{
        const pA = a.A ? clamp(a.A.success_probability_percent/100, 0.05, 0.90) : null;
        const pAR = a.AR ? clamp(a.AR.probAR_percent/100, 0.05, 0.90) : null;
        const latest = (pAR ?? pA);
        const delta = (a.AR && a.A) ? a.AR.delta_percent : null;
        return {...a, latest, delta};
      }).sort((x,y)=> (y.latest ?? -1) - (x.latest ?? -1));

      $("summaryActions").innerHTML = sorted.map((a, idx)=>{
        const latest = a.latest ?? 0;
        const st = statusByProb01(latest);
        const aTxt = a.A ? `${Math.round(a.A.success_probability_percent)}%` : "—";
        const arTxt = a.AR ? `${Math.round(a.AR.probAR_percent)}%` : "—";
        const dTxt = (a.delta==null) ? "—" : `${a.delta>=0?"+":""}${Math.round(a.delta)}%`;
        const types = (a.resourceTypes||[]).join("、") || "—";
        const conf = a.A?.confidence_level || "—";
        const constraint = a.A?.key_constraint || "—";
        return `
          <div class="item">
            <div class="itemhead">
              <strong>${idx+1}. ${escapeHtml(a.content || "（未填写举措）")}</strong>
              <span class="tag ${st.cls}">最新：${a.latest==null?"—":pct(a.latest)+"%"}</span>
            </div>
            <div class="hint">资源类型：${escapeHtml(types)} ｜ 置信度：<span class="mono">${escapeHtml(conf)}</span></div>
            <div class="hint">关键约束：${escapeHtml(constraint)}</div>
            <div class="divider"></div>
            <div class="hint">
              A：<span class="mono">${escapeHtml(aTxt)}</span> ｜ A+R：<span class="mono">${escapeHtml(arTxt)}</span> ｜ 变化：<span class="mono">${escapeHtml(dTxt)}</span>
            </div>
          </div>
        `;
      }).join("") || `<div class="hint">暂无举措。</div>`;

      renderFinalAdvice();
      buildPrintArea(sorted);
    }

    function buildPrintArea(sortedActions){
      const clarity = goalClarityScore();
      const days = daysToDeadline(state.goal.deadline);
      const g = state.goal;
      const r = state.resources;

      const metrics = (g.metrics||[]).map(m=>{
        return `<li><b>${escapeHtml(m.name||"（未命名指标）")}</b>：基线 ${escapeHtml(m.baseline||"—")}；目标 ${escapeHtml(m.target||"—")}</li>`;
      }).join("") || `<li>（暂无指标）</li>`;

      const actionsHtml = (sortedActions||[]).map((a, i)=>{
        const latest = a.latest ?? 0;
        const st = statusByProb01(latest);
        const types = (a.resourceTypes||[]).join("、") || "—";
        const aTxt = a.A ? `${Math.round(a.A.success_probability_percent)}%` : "—";
        const arTxt = a.AR ? `${Math.round(a.AR.probAR_percent)}%` : "—";
        const dTxt = (a.delta==null) ? "—" : `${a.delta>=0?"+":""}${Math.round(a.delta)}%`;
        const conf = a.A?.confidence_level || "—";
        const constraint = a.A?.key_constraint || "—";
        const levers = (a.A?.next_levers || []).map(x=>`<li>${escapeHtml(x)}</li>`).join("") || `<li>—</li>`;
        const moves = (a.AR?.next_alignment_moves || []).map(x=>`<li>${escapeHtml(x)}</li>`).join("") || `<li>—</li>`;

        return `
          <div class="print-card">
            <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
              <div>
                <h3 style="margin:0 0 6px 0;">${i+1}. ${escapeHtml(a.content || "（未填写举措）")}</h3>
                <div class="muted" style="font-size:12px; line-height:1.6;">
                  资源类型：${escapeHtml(types)} ｜ 置信度：<span class="mono">${escapeHtml(conf)}</span>
                </div>
              </div>
              <span class="tag ${st.cls}">最新：${pct(latest)}%</span>
            </div>

            <div style="margin-top:8px; font-size:12px; line-height:1.6;">
              A：<span class="mono">${escapeHtml(aTxt)}</span>
              &nbsp;｜&nbsp;
              A+R：<span class="mono">${escapeHtml(arTxt)}</span>
              &nbsp;｜&nbsp;
              变化：<span class="mono">${escapeHtml(dTxt)}</span>
            </div>

            <div style="margin-top:8px; font-size:12px; line-height:1.6;">
              <b>关键约束：</b>${escapeHtml(constraint)}
            </div>

            <div style="margin-top:8px; font-size:12px; line-height:1.6;">
              <b>提升杠杆（A阶段）</b>
              <ul style="margin:6px 0 0 18px;">${levers}</ul>
            </div>

            <div style="margin-top:8px; font-size:12px; line-height:1.6;">
              <b>对齐动作（R阶段）</b>
              <ul style="margin:6px 0 0 18px;">${moves}</ul>
            </div>
          </div>
        `;
      }).join("") || `<div class="print-card">（暂无举措）</div>`;

      const stakeholdersHtml = (state.stakeholders||[]).map(s=>{
        const d = s.diag || {};
        const like = d.support_likelihood || "—";
        const cls = like==="高" ? "ok" : (like==="中" ? "warn" : "bad");
        const risks = (d.risks||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("") || `<li>—</li>`;
        const imps = (d.improve_suggestions||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("") || `<li>—</li>`;
        return `
          <div class="print-card">
            <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
              <h3 style="margin:0 0 6px 0;">${escapeHtml(s.name || "（未命名相关方）")}</h3>
              <span class="tag ${cls}">支持可能性：${escapeHtml(like)}</span>
            </div>
            <div class="muted" style="font-size:12px; line-height:1.6;">
              <b>需求：</b>${escapeHtml(s.need || "—")}<br/>
              <b>希望对方支持：</b>${escapeHtml(s.expectedSupport || "—")}<br/>
              <b>我能提供支持：</b>${escapeHtml(s.offeredSupport || "—")}
            </div>
            <div style="margin-top:8px; font-size:12px; line-height:1.6;">
              <b>风险</b>
              <ul style="margin:6px 0 0 18px;">${risks}</ul>
            </div>
            <div style="margin-top:8px; font-size:12px; line-height:1.6;">
              <b>改进建议</b>
              <ul style="margin:6px 0 0 18px;">${imps}</ul>
            </div>
          </div>
        `;
      }).join("") || `<div class="print-card">（未填写相关方）</div>`;

      let adviceHtml = "（尚未评估）";
      if(state.ai.adviceAfterAR || state.ai.adviceAfterA){
        const finalBox = $("finalAdvice");
        adviceHtml = `<div style="font-size:12px; line-height:1.6;">${finalBox?.innerHTML || ""}</div>`;
      }

      $("printArea").innerHTML = `
        <div class="print-card">
          <h2 style="margin:0 0 6px 0;">SMART 目标管理输出（AI准备度概率版）</h2>
          <div class="muted" style="font-size:12px; line-height:1.6;">
            导出时间：${escapeHtml(new Date().toLocaleString())}<br/>
            目标清晰度：<span class="mono">${pct(clarity)}%</span>
            ${days==null ? "" : `｜距截止期：<span class="mono">${days>=0?days+"天":"已过期"}</span>`}
            <br/>
            <b>注：</b>成功概率=成功准备度，用于理性取舍与复盘，不代表真实世界的确定预测。
          </div>
        </div>

        <div class="print-card">
          <h3 style="margin:0 0 6px 0;">S（具体是什么）</h3>
          <div style="font-size:12px; line-height:1.6;">${escapeHtml(g.specific || "（未填写）")}</div>
        </div>

        <div class="print-card">
          <h3 style="margin:0 0 6px 0;">M（指标：名称 / 基线 / 目标值）</h3>
          <ul style="margin:6px 0 0 18px; font-size:12px; line-height:1.6;">${metrics}</ul>
        </div>

        <div class="print-card">
          <h3 style="margin:0 0 6px 0;">T（截止日期）</h3>
          <div style="font-size:12px; line-height:1.6;"><span class="mono">${escapeHtml(g.deadline || "（未设置）")}</span></div>
        </div>

        <div class="print-card">
          <h3 style="margin:0 0 6px 0;">A（资源盘点）</h3>
          <div class="muted" style="font-size:12px; line-height:1.6;">
            时间（小时/周）：<span class="mono">${escapeHtml((r.timePerWeek||0).toFixed(1))}</span><br/>
            技能/经验条目数：<span class="mono">${escapeHtml(String(tokenize(r.skills).length))}</span><br/>
            预算（元）：<span class="mono">${escapeHtml(String(r.budget||0))}</span><br/>
            工具/信息条目数：<span class="mono">${escapeHtml(String(tokenize(r.tools).length))}</span><br/>
            人脉资源数量：<span class="mono">${escapeHtml(String(r.network||0))}</span><br/>
            环境支持度：<span class="mono">${escapeHtml(String(r.envSupport||0))}/10</span><br/>
            主要限制/摩擦：${escapeHtml(r.constraints || "—")}
          </div>
        </div>

        <div class="print-card">
          <h3 style="margin:0 0 6px 0;">举措排序（按最新概率）</h3>
          ${actionsHtml}
        </div>

        <div class="pagebreak"></div>

        <div class="print-card">
          <h3 style="margin:0 0 6px 0;">R（相关方：需求 + 互换）</h3>
          ${stakeholdersHtml}
        </div>

        <div class="print-card">
          <h3 style="margin:0 0 6px 0;">最终策略优化建议（AI）</h3>
          ${adviceHtml}
        </div>
      `;
    }

    window.addEventListener("afterprint", ()=>{
      $("printArea").classList.add("hidden");
    });

    $("exportPdf").addEventListener("click", ()=>{
      renderSummary();
      $("printArea").classList.remove("hidden");
      window.print();
      $("exportMsg").textContent = "已打开打印窗口：请选择“另存为PDF”。";
    });

    $("copyText").addEventListener("click", async ()=>{
      const txt = buildPlainText();
      try{
        await navigator.clipboard.writeText(txt);
        $("exportMsg").textContent = "已复制摘要到剪贴板。";
      }catch(e){
        $("exportMsg").textContent = "复制失败：浏览器可能不允许剪贴板写入。你可以用导出PDF。";
      }
    });

    function buildPlainText(){
      const g = state.goal;
      const ms = (g.metrics||[]).map(m => `- ${m.name||"（未命名指标）"}：基线 ${m.baseline||"—"}；目标 ${m.target||"—"}`).join("\n");

      const sorted = state.actions.map(a=>{
        const pA = a.A ? clamp(a.A.success_probability_percent/100, 0.05, 0.90) : null;
        const pAR = a.AR ? clamp(a.AR.probAR_percent/100, 0.05, 0.90) : null;
        const latest = (pAR ?? pA);
        const delta = (a.AR && a.A) ? a.AR.delta_percent : null;
        return {...a, latest, delta};
      }).sort((x,y)=> (y.latest ?? -1) - (x.latest ?? -1));

      const acts = sorted.map((a,i)=>{
        const latest = a.latest==null ? "—" : (pct(a.latest)+"%");
        const d = a.delta==null ? "—" : `${a.delta>=0?"+":""}${Math.round(a.delta)}%`;
        const conf = a.A?.confidence_level || "—";
        const constraint = a.A?.key_constraint || "—";
        return `${i+1}. ${a.content||"（未填写举措）"}\n   - 最新：${latest}（变化：${d}）\n   - 置信度：${conf}\n   - 关键约束：${constraint}`;
      }).join("\n\n");

      const sh = (state.stakeholders||[]).map(s=>{
        const like = s.diag?.support_likelihood || "—";
        return `- ${s.name||"（未命名相关方）"}（支持可能性：${like}）\n  需求：${s.need||"—"}\n  希望支持：${s.expectedSupport||"—"}\n  我能提供：${s.offeredSupport||"—"}`;
      }).join("\n\n") || "（未填写相关方）";

      const advice = $("finalAdvice")?.innerText?.trim() || "（尚未评估）";

      return [
        "SMART 目标管理输出（AI准备度概率版）",
        "",
        "S:", g.specific || "（未填写）",
        "",
        "M:", ms || "（暂无指标）",
        "",
        "T:", g.deadline || "（未设置）",
        "",
        "举措（按最新概率排序）：",
        acts || "（暂无举措）",
        "",
        "相关方（需求 + 互换）：",
        sh,
        "",
        "最终策略优化建议（AI）：",
        advice
      ].join("\n");
    }

    $("resetAll").addEventListener("click", ()=> location.reload());
    $("goStep4").addEventListener("click", ()=>{ renderSummary(); showStep(4); });

    // =========================
    // 初始化
    // =========================
    function init(){
      addMetricRow({ name:"核心指标", baseline:"0", target:"（写清目标值+单位）" });

      addActionCard({
        content:"举措1：高频小步推进（例：每周输出1份可验证交付物）",
        resourceTypes:["时间","技能/经验"],
        dependencyMode:"AUTO"
      });
      addActionCard({
        content:"举措2：借力提效（例：用工具/信息模板化，把重复劳动降到最低）",
        resourceTypes:["工具/信息","时间"],
        dependencyMode:"AUTO"
      });
      addActionCard({
        content:"举措3：对齐关键人（例：先争取1次试点授权/资源支持再扩展）",
        resourceTypes:["人脉资源","环境支持"],
        dependencyMode:"AUTO"
      });

      addStakeholderCard({
        name:"相关方A（示例）",
        need:"希望风险可控、过程透明、结果可验证",
        expectedSupport:"给试点授权/协调资源",
        offeredSupport:"我提供试点数据复盘+模板，降低TA风险"
      });

      collectStep1();
      collectResources();
      renderResourceKpi();
      renderCompareBoard();
      renderAdviceAfterA();
      renderAdviceAfterAR();
      renderFinalAdvice();
      showStep(1);
    }
    init();
  </script>
</body>
</html>
